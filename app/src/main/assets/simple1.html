<!DOCTYPE html>

<meta charset="UTF-8">
<title>WebCodecs API Streamr Demo</title>
<style>
    button {
        background-color: #555555;
        border: 2px;
        border-radius: 2px;
        color: white;
        padding: 15px 32px;
        width: 1280px;
        text-align: center;
        display: block;
        font-size: 16px;
    }
</style>

<body>
    <div>Hello World!</div>
    <div id="uuid">My id is: </div>
    <div id="textbox"></div>
</body>
<script type="text/javascript" src="streamr-client.web.min.js"></script>
<script>

    function generateUUID() {
        let uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        return uuid;
    }
    const uuid = generateUUID()

    document.getElementById("uuid").textContent = "My id is: " + uuid

    function addText(content) {
        var textbox = document.getElementById("textbox");
        var newText = document.createElement("p");
        newText.textContent = content;
        textbox.insertBefore(newText, textbox.firstChild)
        textbox.scrollTop = textbox.scrollHeight;
    }

    const client = new StreamrClient({
        auth: {
            privateKey: "13e1f58ff9896f48e9f0ff4a8d6b93d889fedca00c97a18d1f35b06e18b99b3a"
        },
        logLevel: 'trace'
    })

    async function sendMsgToStreamr(msg) {
        const message = { content: msg, sender: uuid }
        const response = await client.publish({ id: "0x937934175ca694b5f66f4c96b11f25a326b4cc5d/demostream", partition: 3 }, message)
        addText("Me: " + msg)
    }

    const { address, privateKey } = StreamrClient.generateEthereumAccount();

    client.subscribe({ id: "0x937934175ca694b5f66f4c96b11f25a326b4cc5d/demostream", partition: 3 },
        (content, metadata) => {
            if (!(content?.sender == uuid)) {
                addText(content?.sender + ": " + content?.content)
            }

        })

</script>